# Muscle Dreamer 要件定義書（逆生成）

## 分析概要

**分析日時**: 2025-08-03  
**対象コードベース**: /home/devman/GolandProjects/muscle-dreamer  
**抽出要件数**: 25個の機能要件、15個の非機能要件  
**信頼度**: 85% （実装カバレッジと設計ドキュメントに基づく）  
**分析対象**: Go 1.22 + Ebitengine v2.6.3  

## システム概要

### 推定されたシステム目的

Muscle Dreamerは、モジュラー設計とセキュリティを重視した2Dサバイバルアクションローグライクゲームです。ECSアーキテクチャを採用し、安全なMODシステムとテーマシステムにより高い拡張性を実現しています。オフライン動作を前提とし、WebAssemblyによるブラウザ対応も提供します。

### 対象ユーザー

1. **ゲームプレイヤー**: ローグライクゲームを楽しむエンドユーザー
2. **コンテンツクリエイター**: テーマやMODを作成する開発者・デザイナー
3. **Web開発者**: WebAssemblyとしてゲームを統合する開発者
4. **ゲーム管理者**: MODの管理・セキュリティを担当する運用者

## ユーザーストーリー

### ストーリー1: ゲームプレイヤーとしての基本体験
- **として** ゲームプレイヤー **である私は**
- **したい** 安定した60FPSでゲームをプレイ **することを**
- **そうすることで** 滑らかなゲーム体験を得られる

**実装根拠**: 
- `core/game.go` - Ebitengineゲームループ実装
- `config/game.yaml` - グラフィック・オーディオ設定
- パフォーマンステスト仕様（60FPS保証）

### ストーリー2: プラットフォーム横断利用
- **として** 様々なデバイスのユーザー **である私は**
- **したい** Windows、Linux、macOS、ブラウザでゲームを実行 **することを**
- **そうすることで** 環境に依存せずゲームを楽しめる

**実装根拠**: 
- `Makefile` - クロスプラットフォームビルド設定
- `web/` ディレクトリ - WebAssembly対応
- Dockerコンテナ開発環境

### ストーリー3: コンテンツクリエイターとしてのカスタマイズ
- **として** コンテンツクリエイター **である私は**
- **したい** 安全なサンドボックス環境でMODを作成 **することを**
- **そうすることで** システムを破壊することなくゲームを拡張できる

**実装根拠**: 
- `mods/` ディレクトリ構造（enabled/disabled/staging）
- `docs/reverse/interfaces/` - MODセキュリティインターフェース
- MODサンドボックステスト実装

### ストーリー4: テーマカスタマイズ
- **として** ゲームプレイヤー・クリエイター **である私は**
- **したい** 動的にゲームテーマを変更 **することを**
- **そうすることで** 視覚的・聴覚的体験をカスタマイズできる

**実装根拠**: 
- `themes/` ディレクトリ - テーマシステム実装
- `assets/` - アセット管理構造
- テーマローディングシステム設計

### ストーリー5: Web開発者としての統合
- **として** Web開発者 **である私は**
- **したい** ゲームをWebアプリケーションに統合 **することを**
- **そうすることで** ブラウザベースのゲーミング体験を提供できる

**実装根拠**: 
- `web/` ディレクトリ - Express.jsサーバー
- WebAssemblyビルド設定
- ブラウザ互換性テスト仕様

## 機能要件（EARS記法）

### 通常要件（SHALL）

#### REQ-001: ゲームループ実行
システムは60FPSでゲームの更新と描画処理を実行しなければならない。

**実装根拠**: 
- `core/game.go:Update()` - ゲーム状態更新
- `core/game.go:Draw()` - 画面描画処理
- Ebitengineフレームワークによる60FPS制御

#### REQ-002: 設定管理
システムはYAML形式の設定ファイルからゲーム設定を読み込まなければならない。

**実装根拠**:
- `config/game.yaml` - 設定ファイル定義
- グラフィック（解像度、フルスクリーン、Vsync）設定
- オーディオ（マスター、BGM、SFXボリューム）設定
- 入力デバイス（キーボード、マウス、ゲームパッド）設定

#### REQ-003: マルチプラットフォーム対応
システムはWindows、Linux、macOS、WebAssemblyで動作しなければならない。

**実装根拠**:
- `Makefile` - プラットフォーム別ビルドターゲット
- `GOOS`/`GOARCH` 環境変数によるクロスコンパイル
- WebAssembly特化ビルド設定

#### REQ-004: アセット管理
システムは画像、音声、フォントアセットを効率的に管理しなければならない。

**実装根拠**:
- `assets/` ディレクトリ構造（sprites, audio, fonts, ui）
- アセット管理インターフェース設計
- アセットローディング・キャッシュシステム

#### REQ-005: ECSアーキテクチャ
システムはEntity Component Systemアーキテクチャを実装しなければならない。

**実装根拠**:
- `docs/reverse/interfaces/` - ECSインターフェース定義
- EntityManager, SystemManager実装仕様
- コンポーネント型システム設計

### 条件付き要件（WHEN/IF-THEN）

#### REQ-101: WebAssembly環境判定
実行環境がWebAssemblyの場合、システムはブラウザ固有の制約に対応しなければならない。

**実装根拠**:
- `runtime.GOOS == "js"` による環境判定
- WebAssemblyメモリ制限対応
- ブラウザAPI連携機能

#### REQ-102: エラー時の安全な停止
ゲーム実行中にエラーが発生した場合、システムは安全にゲームを停止しなければならない。

**実装根拠**:
- `main.go` - `log.Fatal(err)` エラーハンドリング
- ゲームループ内のエラー処理
- リソースクリーンアップ機能

#### REQ-103: MOD権限管理
MODが制限された権限で実行される場合、システムは対応するサンドボックス制約を適用しなければならない。

**実装根拠**:
- MODPermissions構造体定義
- ファイルアクセス制限（FileAccess配列）
- ネットワーク・システムアクセス制御

### 状態要件（WHERE）

#### REQ-201: ゲーム状態管理
システムはメニュー、ゲームプレイ、ポーズなどの状態を適切に管理しなければならない。

**実装根拠**:
- ゲーム状態遷移システム設計
- 状態固有の更新・描画処理
- 状態間のデータ永続性

#### REQ-202: テーマ状態
現在のテーマが適用されている状態で、システムは対応するアセットとスタイルを使用しなければならない。

**実装根拠**:
- `themes/default/` - デフォルトテーマ実装
- テーマ切り替えシステム
- アセット動的ローディング

### オプション要件（MAY）

#### REQ-301: ウィンドウリサイズ
システムはユーザーがウィンドウサイズを変更することを許可してもよい。

**実装根拠**:
- `ebiten.SetWindowResizable(true)` 設定
- `Layout()` メソッドでの解像度対応

#### REQ-302: デバッグ情報表示
開発モードでシステムはデバッグ情報を画面に表示してもよい。

**実装根拠**:
- `ebitenutil.DebugPrint()` 実装
- 開発中メッセージ表示

### 制約要件（MUST）

#### REQ-401: MODファイルアクセス制限
MODシステムは指定されたディレクトリ外へのファイルアクセスを禁止しなければならない。

**実装根拠**:
- パストラバーサル攻撃対策（../../../etc/passwd）
- ファイルパス検証機能
- サンドボックス境界制御

#### REQ-402: セキュリティ制約
システムはMODによる以下の操作を禁止しなければならない：
- システムコマンド実行
- 制限外ネットワークアクセス
- 他プロセスとの通信

**実装根拠**:
- MODサンドボックス実装
- ネットワークアクセス制御
- システムAPI呼び出し制限

#### REQ-403: リソース制限
システムはメモリ使用量を256MB未満に制限しなければならない。

**実装根拠**:
- CLAUDE.md - パフォーマンス目標定義
- メモリ使用量監視機能
- ガベージコレクション最適化

## 非機能要件

### パフォーマンス

#### NFR-001: フレームレート保証
システムは通常動作時に60FPS（16.67ms/フレーム）を維持しなければならない。

**実装根拠**:
- Ebitengineフレームワークの60FPS制御
- パフォーマンステスト仕様（TC-017）
- フレーム時間測定・監視機能

#### NFR-002: 起動時間
システムは起動から3秒以内にゲーム画面を表示しなければならない。

**実装根拠**:
- CLAUDE.md - パフォーマンス目標定義
- アセット遅延ローディング設計
- 起動プロセス最適化

#### NFR-003: メモリ使用効率
システムは実行時メモリ使用量を256MB未満に維持しなければならない。

**実装根拠**:
- Go言語のガベージコレクション活用
- ECSアーキテクチャによる効率的メモリ管理
- メモリプロファイリング機能

### セキュリティ

#### NFR-101: MODサンドボックス分離
システムはMODを安全なサンドボックス環境で実行しなければならない。

**実装根拠**:
- `docs/reverse/security_interface_test.go` - セキュリティテスト
- ファイルシステムアクセス制限
- ネットワーク・システムコール制限

#### NFR-102: 入力検証
システムは全ての外部入力に対して適切な検証を実行しなければならない。

**実装根拠**:
- 設定ファイルバリデーション
- MODコード静的解析
- XSS・SQLインジェクション対策

#### NFR-103: エラー情報制限
システムはエラーメッセージで内部情報を漏洩してはならない。

**実装根拠**:
- 安全なエラーハンドリング実装
- ログ出力のセキュリティ考慮
- デバッグ情報の本番環境無効化

### 互換性

#### NFR-201: クロスプラットフォーム動作
システムは主要OS（Windows、Linux、macOS）で同等の機能を提供しなければならない。

**実装根拠**:
- Go言語のクロスプラットフォーム対応
- プラットフォーム抽象化層設計
- プラットフォーム別ビルド・テスト

#### NFR-202: WebAssembly互換性
システムはWebAssembly環境で基本機能を提供しなければならない。

**実装根拠**:
- `web/` ディレクトリ - WebAssembly対応実装
- ブラウザAPI連携機能
- WebAssembly特化テスト

#### NFR-203: オフライン動作
システムはインターネット接続なしで完全に動作しなければならない。

**実装根拠**:
- CLAUDE.md - オフライン動作要件
- ローカルアセット管理
- 外部依存性の排除

### ユーザビリティ

#### NFR-301: 日本語対応
システムは日本語でのユーザーインターフェースを提供しなければならない。

**実装根拠**:
- `config/game.yaml` - 日本語タイトル設定
- `themes/default/localization/` - 多言語対応構造
- フォントシステムでの日本語サポート

#### NFR-302: 直感的操作
システムは複数の入力デバイス（キーボード、マウス、ゲームパッド）をサポートしなければならない。

**実装根拠**:
- `config/game.yaml` - 入力デバイス設定
- Ebitengineの入力システム活用
- デバイス検出・切り替え機能

#### NFR-303: 設定カスタマイズ
システムはユーザーが音量、解像度、入力設定を変更できなければならない。

**実装根拠**:
- 設定ファイルによる永続化
- リアルタイム設定反映
- 設定値範囲検証

### 拡張性

#### NFR-401: モジュラー設計
システムはコンポーネント単位での機能拡張を可能にしなければならない。

**実装根拠**:
- ECSアーキテクチャ採用
- プラグインシステム設計
- インターフェース分離原則の適用

#### NFR-402: テーマシステム
システムは外部テーマパッケージの動的ローディングを可能にしなければならない。

**実装根拠**:
- `themes/` ディレクトリ構造
- テーマ定義ファイル（theme.yaml）
- アセット動的置換機能

#### NFR-403: MODシステム
システムは安全なMODプラグイン拡張を可能にしなければならない。

**実装根拠**:
- `mods/` ディレクトリ管理
- MOD権限システム
- サンドボックス実行環境

### 運用性

#### NFR-501: ログ出力
システムは運用監視のための適切なログを出力しなければならない。

**実装根拠**:
- 構造化ログ出力機能
- エラー・パフォーマンス情報記録
- ログレベル制御

#### NFR-502: エラー回復
システムは一時的エラーからの自動回復機能を提供しなければならない。

**実装根拡**:
- グレースフルエラーハンドリング
- リソース解放・復旧機能
- 状態一貫性保証

#### NFR-503: リソース管理
システムは使用済みリソースを適切に解放しなければならない。

**実装根拠**:
- Go言語のdefer文活用
- リソースライフサイクル管理
- メモリリーク防止機能

## エッジケース

### セキュリティ攻撃対策

#### EDGE-001: パストラバーサル攻撃
MODが `../../../etc/passwd` のようなパスでファイルアクセスを試行した場合の防御

**実装根拠**:
- `security_interface_test.go` - パストラバーサルテスト
- ファイルパス正規化・検証
- アクセス拒否エラー応答

#### EDGE-002: システムコマンドインジェクション
MODが `rm -rf /` のような危険なシステムコマンドを実行しようとした場合の防御

**実装根拠**:
- システムアクセス権限制御
- コマンド実行禁止機能
- MOD静的コード解析

#### EDGE-003: ネットワーク攻撃
MODが外部サーバーへの不正通信を試行した場合の防御

**実装根拠**:
- ネットワークアクセス制限
- 通信プロトコル制御
- MOD権限管理システム

### リソース制限

#### EDGE-101: メモリ枯渇
大量のエンティティ作成によりメモリ不足が発生した場合の処理

**実装根拠**:
- ECS性能テスト（10,000エンティティ）
- メモリ使用量監視
- ガベージコレクション制御

#### EDGE-102: ファイルサイズ制限
巨大なアセットファイル（100MB+）の読み込み試行

**実装根拠**:
- アセットサイズ制限設定
- ファイルサイズ事前チェック
- 分割読み込み・ストリーミング

#### EDGE-103: 長時間実行
24時間連続実行でのメモリリーク・パフォーマンス劣化

**実装根拠**:
- 長時間安定性テスト仕様
- 定期的リソースクリーンアップ
- パフォーマンス監視機能

### プラットフォーム固有

#### EDGE-201: WebAssemblyメモリ制限
ブラウザ環境でのメモリ制約による動作不良

**実装根拠**:
- WebAssembly環境判定
- メモリ使用量最適化
- ブラウザ互換性テスト

#### EDGE-202: ファイルシステム非対応
WebAssembly環境でのローカルファイルアクセス制限

**実装根拠**:
- プラットフォーム抽象化
- IndexedDB代替ストレージ
- 機能検出・フォールバック

#### EDGE-203: 異なる解像度・DPI
様々な画面解像度・DPI設定での表示調整

**実装根拠**:
- レスポンシブレイアウト実装
- DPIスケーリング対応
- 動的解像度調整

## 受け入れ基準

### 実装済み機能テスト

#### ✅ ゲームコア機能
- [x] **ゲームインスタンス作成** - `core.NewGame()` 正常動作
- [x] **ゲームループ実行** - `Update()` 冪等性・エラーなし実行
- [x] **描画処理** - 背景色設定・デバッグテキスト表示
- [x] **ウィンドウ管理** - サイズ設定・タイトル設定・リサイズ対応

#### ✅ 設定管理機能
- [x] **YAML設定読み込み** - `config/game.yaml` パース成功
- [x] **設定値検証** - 解像度・音量範囲・入力デバイス設定
- [x] **多言語タイトル** - 日本語タイトル表示対応

#### ✅ プラットフォーム対応
- [x] **クロスプラットフォームビルド** - Windows/Linux/macOS/WebAssembly
- [x] **開発環境** - Docker対応・Makefile自動化
- [x] **Web統合** - Express.jsサーバー・WebAssembly連携

#### ✅ アーキテクチャ設計
- [x] **ECSインターフェース** - Entity/Component/System定義
- [x] **モジュラー構造** - `internal/` パッケージ分離
- [x] **拡張性基盤** - MOD・テーマシステム設計

### 推奨追加テスト

#### 🔶 パフォーマンステスト
- [ ] **60FPS維持テスト** - 5秒間安定フレームレート測定
  - 目標: 平均58FPS以上、95%のフレームが20ms以内
- [ ] **メモリ使用量テスト** - 1000フレーム実行後のメモリ増加量
  - 目標: 増加量10MB未満
- [ ] **起動時間テスト** - アプリケーション起動からゲーム画面表示まで
  - 目標: 3秒以内
- [ ] **大量エンティティ負荷テスト** - 1000エンティティでのシステム性能
  - 目標: 60フレーム処理を1秒以内

#### 🔶 セキュリティテスト
- [ ] **MODサンドボックステスト** - ファイルアクセス制限検証
  - パストラバーサル攻撃（`../../../etc/passwd`）防御
  - 絶対パス（`/etc/passwd`）アクセス拒否
  - Windows形式パス（`C:\Windows\System32`）対策
- [ ] **ネットワーク制限テスト** - MODの外部通信制御
  - HTTP/HTTPS GET リクエスト拒否
  - TCP/UDP接続試行拒否
  - DNS ルックアップ制限
- [ ] **システムコマンド制限テスト** - 危険コマンド実行防止
  - `rm -rf /`、`cat /etc/passwd` 実行拒否
  - シェルスクリプト実行制限
- [ ] **コード静的解析テスト** - MODスクリプトの脅威検出
  - 危険API使用検出（`os.Exit`、`exec.Command`）
  - ネットワークAPI検出（`http.Get`、`net.Dial`）

#### 🔶 統合・E2Eテスト
- [ ] **WebAssembly統合テスト** - ブラウザ環境での動作確認
  - ゲーム正常起動・Canvas表示確認
  - JavaScript ↔ WebAssembly通信テスト
  - エラーハンドリング・フォールバック機能
- [ ] **テーマシステムテスト** - 動的テーマ切り替え
  - デフォルトテーマ読み込み・適用
  - カスタムテーマ作成・検証
  - アセット動的置換確認
- [ ] **ECS統合テスト** - Entity Component System動作
  - 10,000エンティティ作成・削除性能
  - システム実行順序・エラーハンドリング
  - コンポーネントクエリ効率

#### 🔶 長期安定性テスト
- [ ] **24時間連続実行テスト** - メモリリーク・安定性確認
  - エラー発生率 < 0.01%
  - メモリ増加量 < 50MB
  - フレームレート維持
- [ ] **リソース解放テスト** - 適切なクリーンアップ確認
  - ファイルハンドル・メモリリーク検出
  - グレースフル終了処理
  - リソース使用量監視

#### 🔶 アクセシビリティ・ユーザビリティテスト
- [ ] **入力デバイステスト** - 複数デバイス対応確認
  - キーボード・マウス・ゲームパッド切り替え
  - 設定値永続化・リアルタイム反映
- [ ] **多言語対応テスト** - 日本語表示・フォント対応
  - 文字化け・レイアウト崩れ確認
  - 多言語リソース動的読み込み
- [ ] **レスポンシブ対応テスト** - 異なる解像度での表示
  - 4K・フルHD・HD解像度対応
  - DPIスケーリング・アスペクト比維持

## 推定されていない要件

### 不明確な部分

以下の要件は実装から推定が困難なため、ステークホルダーとの確認が必要です：

#### 1. ビジネス要件
- **収益モデル**: フリー・有料・サブスクリプション・広告モデル
- **対象市場**: 年齢層・地域・ゲーマーセグメント
- **競合分析**: 類似ゲームとの差別化ポイント
- **成功指標**: DAU・課金率・ユーザー満足度目標

#### 2. ゲームプレイ要件
- **ゲームバランス**: 難易度・進行速度・リワード設計
- **プレイ時間**: 1セッション・全体クリア時間目標
- **ユーザー体験**: チュートリアル・操作感・UI/UX詳細
- **ゲーム進行**: セーブ・ロード・進捗管理システム

#### 3. 運用・サポート要件
- **カスタマーサポート**: 問い合わせ・バグ報告・フィードバック対応
- **アップデート方針**: 頻度・配信方法・ダウンタイム許容度
- **コミュニティ管理**: フォーラム・SNS・ユーザー生成コンテンツ
- **データ分析**: ユーザー行動・プレイ統計・改善指標

#### 4. 法的・コンプライアンス要件
- **データ保護**: GDPR・個人情報保護法・Cookie対応
- **年齢制限**: CERO・ESRB・PEGI レーティング準拠
- **著作権**: 使用アセット・音楽・フォントライセンス確認
- **規制対応**: 各国ゲーム規制・アクセシビリティ法準拠

#### 5. 技術仕様詳細
- **セーブデータ形式**: JSON・バイナリ・暗号化仕様
- **ネットワーク機能**: オンライン要素・マルチプレイヤー対応
- **外部連携**: Steam・Discord・ソーシャル機能統合
- **分析基盤**: テレメトリー・クラッシュレポート・メトリクス

### 推奨される次ステップ

#### フェーズ1: ステークホルダー確認（1週間）
1. **プロダクトオーナーインタビュー** - ビジネス要件・目標確認
2. **ユーザーリサーチ** - ターゲットユーザー・ニーズ調査
3. **競合分析** - 市場ポジション・差別化要素特定

#### フェーズ2: 技術検証（2週間）
1. **パフォーマンステスト実装** - 60FPS保証・メモリ制限検証
2. **セキュリティ監査** - MODサンドボックス・脆弱性確認
3. **プラットフォーム互換性確認** - 全環境での動作保証

#### フェーズ3: ユーザビリティ検証（1週間）
1. **ユーザビリティテスト** - 実際のユーザーによる操作感確認
2. **アクセシビリティ監査** - 障害者対応・多様性確認
3. **多言語対応確認** - 国際化要件・文化的配慮

#### フェーズ4: 運用準備（1週間）
1. **運用手順書作成** - デプロイ・監視・障害対応
2. **サポート体制構築** - ユーザーサポート・コミュニティ管理
3. **リリース計画策定** - マーケティング・配信戦略

## 分析の制約事項

### 信頼度に影響する要因

#### 🟢 高信頼度 (85%): 明確な実装根拠
- **コア機能**: ゲームループ・設定管理・プラットフォーム対応
- **アーキテクチャ**: ECS・MOD・テーマシステム設計
- **セキュリティ**: サンドボックス・入力検証実装
- **パフォーマンス**: 60FPS・メモリ制限要件

#### 🟡 中信頼度 (60%): 部分的実装・推定
- **ユーザビリティ**: UI/UX詳細・操作感
- **ゲームプレイ**: バランス・進行・セーブシステム
- **運用**: ログ・監視・エラー追跡詳細

#### 🟠 低信頼度 (30%): 推定・外挿
- **ビジネス要件**: 収益モデル・市場戦略
- **法的要件**: コンプライアンス・規制対応
- **外部連携**: サードパーティ統合・API仕様

### 分析の根拠強度

#### 🔴 **強い根拠**: 実装 + テスト + ドキュメント
- ECSアーキテクチャ（インターフェース + テスト）
- セキュリティ要件（実装 + 攻撃テスト）
- パフォーマンス要件（目標値 + 測定コード）
- プラットフォーム対応（ビルド設定 + 環境判定）

#### 🟡 **中程度の根拠**: 実装 + 部分的テスト
- 設定管理（YAML + バリデーション）
- アセット管理（ディレクトリ構造 + ローディング）
- WebAssembly対応（ビルド設定 + 環境設定）

#### 🟠 **弱い根拠**: 実装のみ、推定で補完
- ユーザーストーリー（機能実装から逆算）
- ビジネス要件（システム目的から推定）
- 詳細ユーザビリティ（設計思想から推定）

### 推定の妥当性

この要件定義書は以下の原則に基づいて作成されています：

1. **実装ファースト**: 実装されたコードを最優先の根拠とする
2. **保守的推定**: 不明確な部分は控えめに推定する
3. **明確な区別**: 確実・推定・不明を明確に区別する
4. **検証可能性**: 後から確認・修正可能な形で文書化する

---

**📋 要件定義書の活用方法**

1. **開発チーム**: 実装の妥当性確認・追加開発指針
2. **QAチーム**: テストケース作成・品質基準設定
3. **プロダクトオーナー**: ビジネス要件確認・優先度調整
4. **ステークホルダー**: プロジェクト理解・意思決定支援

この文書は実装の逆生成であり、今後の要件変更・追加に柔軟に対応できる基盤として活用してください。