# ECSフレームワーク要件定義書

## 概要

Muscle Dreamerゲームエンジンの中核となるEntity Component System（ECS）フレームワークの実装要件を定義します。ECSアーキテクチャは高性能なゲームエンジンの基盤であり、エンティティとコンポーネントの管理、システムの実行順序制御、メモリ効率の最適化を提供します。

### 対象ユーザー
- **ゲーム開発者**: ECSを使用してゲーム機能を実装
- **MOD開発者**: ECS APIを通じてゲームを拡張
- **システム設計者**: パフォーマンス最適化とアーキテクチャ設計

## ユーザーストーリー

### ストーリー1: ゲーム開発者としてのエンティティ管理
- **として** ゲーム開発者 **である私は**
- **したい** プレイヤー、敵、アイテムなどのゲームオブジェクトを効率的に管理 **することを**
- **そうすることで** 複雑なゲームロジックを整理された形で実装できる

### ストーリー2: システム開発者としてのコンポーネント設計
- **として** システム開発者 **である私は**
- **したい** 再利用可能なコンポーネント（位置、体力、描画など）を定義 **することを**
- **そうすることで** 機能を組み合わせて多様なゲームオブジェクトを作成できる

### ストーリー3: パフォーマンス重視開発者としての最適化
- **として** パフォーマンス重視の開発者 **である私は**
- **したい** 10,000以上のエンティティを60FPSで処理 **することを**
- **そうすることで** 大規模なゲーム世界を実現できる

### ストーリー4: MOD開発者としてのAPI利用
- **として** MOD開発者 **である私は**
- **したい** 安全なECS APIを通じてゲームシステムを拡張 **することを**
- **そうすることで** 既存ゲームを破壊することなく新機能を追加できる

## 機能要件（EARS記法）

### 通常要件（SHALL）

#### REQ-001: エンティティ管理
システムは一意なEntityIDを生成し、エンティティの作成・削除を管理しなければならない。

#### REQ-002: コンポーネント管理
システムは型安全なコンポーネントの追加・削除・取得機能を提供しなければならない。

#### REQ-003: システム実行
システムは登録されたシステムを定義された順序で実行しなければならない。

#### REQ-004: エンティティクエリ
システムは指定されたコンポーネント型を持つエンティティのクエリ機能を提供しなければならない。

#### REQ-005: メモリ効率管理
システムはコンポーネントデータをメモリ効率的に格納・アクセスできなければならない。

#### REQ-006: 型安全性
システムはコンパイル時に型安全性を保証するインターフェースを提供しなければならない。

### 条件付き要件（WHEN/IF-THEN）

#### REQ-101: エンティティ削除時の整合性
エンティティが削除される場合、システムは関連する全てのコンポーネントを自動的に削除しなければならない。

#### REQ-102: システム実行エラー時の継続
あるシステムの実行でエラーが発生した場合、システムは他のシステムの実行を継続しなければならない。

#### REQ-103: メモリ不足時の処理
利用可能メモリが閾値を下回る場合、システムは未使用エンティティの自動削除を実行しなければならない。

#### REQ-104: コンポーネント型競合時の処理
同一エンティティに同じ型のコンポーネントを追加しようとした場合、システムは既存コンポーネントを置換しなければならない。

### 状態要件（WHERE）

#### REQ-201: ゲーム実行中の状態管理
ゲームが実行中の状態で、システムはリアルタイムでエンティティ・コンポーネントの変更を反映しなければならない。

#### REQ-202: システム登録完了状態
全てのシステムが登録完了した状態で、システムは実行順序の依存関係を検証しなければならない。

### オプション要件（MAY）

#### REQ-301: エンティティプール
システムはエンティティIDの再利用によるメモリ断片化防止を実装してもよい。

#### REQ-302: コンポーネントシリアライゼーション
システムはゲームセーブ・ロード用のコンポーネント直列化機能を提供してもよい。

#### REQ-303: デバッグ機能
システムは開発時のエンティティ・コンポーネント状態可視化機能を提供してもよい。

### 制約要件（MUST）

#### REQ-401: EntityID一意性制約
システムは生成されるEntityIDの一意性を保証しなければならない。

#### REQ-402: システム実行順序制約
システムは循環依存するシステム登録を拒否しなければならない。

#### REQ-403: スレッドセーフティ制約
システムはマルチスレッド環境での同時アクセスに対して安全でなければならない。

## 非機能要件

### パフォーマンス

#### NFR-001: エンティティ作成性能
システムは1フレーム（16.67ms）で最低1,000個のエンティティ作成を処理しなければならない。

#### NFR-002: コンポーネントクエリ性能
システムは10,000エンティティから特定コンポーネント検索を1ms以内で完了しなければならない。

#### NFR-003: システム実行性能
システムは10,000エンティティ・50システムの更新を10ms以内で完了しなければならない。

#### NFR-004: メモリ使用効率
システムは1エンティティあたり平均100バイト以下のメモリオーバーヘッドを維持しなければならない。

### セキュリティ

#### NFR-101: MODサンドボックス分離
システムはMODからのECSアクセスを制限されたAPIのみに制限しなければならない。

#### NFR-102: メモリアクセス制御
システムは不正なメモリアドレスアクセスを防止する保護機能を実装しなければならない。

### 拡張性

#### NFR-201: カスタムコンポーネント対応
システムはユーザー定義コンポーネント型の動的登録を可能にしなければならない。

#### NFR-202: システム追加・削除
システムは実行時のシステム追加・削除を安全に実行できなければならない。

### 保守性

#### NFR-301: エラーメッセージ明確化
システムは開発者が理解しやすい詳細なエラーメッセージを提供しなければならない。

#### NFR-302: APIドキュメント整備
システムは全ての公開APIに対して包括的なドキュメントを提供しなければならない。

## Edgeケース

### エラー処理

#### EDGE-001: 無効EntityIDアクセス
削除済みエンティティIDへのアクセス時は適切なエラーを返し、クラッシュを回避しなければならない。

#### EDGE-002: 存在しないコンポーネント取得
エンティティに存在しないコンポーネント取得時はnilを返し、panic発生を防止しなければならない。

#### EDGE-003: システム実行時間超過
システム実行が制限時間を超過した場合は警告ログを出力し、次フレームに処理を延期しなければならない。

### 境界値

#### EDGE-101: エンティティ数上限
エンティティ数が上限（1,000,000）に達した場合は新規作成を拒否し、エラーを返却しなければならない。

#### EDGE-102: コンポーネントサイズ制限
単一コンポーネントが1MBを超える場合は警告を出力し、メモリ使用量を監視しなければならない。

#### EDGE-103: システム登録数制限
システム登録数が制限値（100システム）を超過する場合は登録を拒否しなければならない。

### 同時実行

#### EDGE-201: 並行エンティティ操作
複数goroutineからの同時エンティティ操作は適切に排他制御されなければならない。

#### EDGE-202: システム並列実行
独立したシステムの並列実行時にデータ競合を防止しなければならない。

## 受け入れ基準

### 機能テスト

#### エンティティ管理テスト
- [ ] 1,000,000個のエンティティ作成・削除が正常に動作する
- [ ] EntityID の一意性が保証される
- [ ] 削除されたEntityIDへのアクセスが適切にエラーを返す

#### コンポーネント管理テスト
- [ ] 基本コンポーネント（Transform, Sprite, Health）の追加・取得・削除が動作する
- [ ] 型安全性が保証され、不正な型アクセスがコンパイルエラーになる
- [ ] 同一型コンポーネントの重複追加が置換動作する

#### システム実行テスト
- [ ] Movement, Rendering, Physics システムが正しい順序で実行される
- [ ] システム実行エラーが他システムに影響しない
- [ ] システムの動的追加・削除が安全に動作する

#### クエリシステムテスト
- [ ] 複数コンポーネント条件での効率的なエンティティ検索が動作する
- [ ] 10,000エンティティから特定条件検索が1ms以内で完了する
- [ ] クエリ結果がリアルタイムで更新される

### パフォーマンステスト

#### 大規模データテスト
- [ ] **10,000エンティティ負荷テスト**: 60FPS維持確認
- [ ] **100,000エンティティストレステスト**: メモリ使用量・処理時間測定
- [ ] **1,000,000エンティティ限界テスト**: システム安定性確認

#### 実行時間テスト
- [ ] **エンティティ作成性能**: 1フレームで1,000個作成（目標: <16ms）
- [ ] **コンポーネントクエリ性能**: 10,000エンティティ検索（目標: <1ms）
- [ ] **システム実行性能**: 全システム実行（目標: <10ms）

#### メモリ効率テスト
- [ ] **メモリ使用量測定**: 1エンティティあたり<100バイト
- [ ] **メモリリーク検証**: 24時間連続実行でメモリ増加<50MB
- [ ] **ガベージコレクション負荷**: GC頻度・停止時間測定

### セキュリティテスト

#### MODサンドボックステスト
- [ ] MODからの直接メモリアクセス拒否確認
- [ ] 制限されたECS API のみアクセス可能確認
- [ ] 不正なシステム登録・実行の防止確認

#### 堅牢性テスト
- [ ] 不正なEntityID・コンポーネント操作の安全な処理
- [ ] システムクラッシュ時の適切な復旧動作
- [ ] マルチスレッド環境でのデータ競合防止

### 統合・E2Eテスト

#### ゲーム統合テスト
- [ ] **プレイヤーエンティティテスト**: Transform+Sprite+Health+Inputコンポーネント組み合わせ
- [ ] **敵エンティティテスト**: Transform+Sprite+Health+AIコンポーネント組み合わせ
- [ ] **アイテムエンティティテスト**: Transform+Sprite+Pickupコンポーネント組み合わせ

#### システム連携テスト
- [ ] **物理システム → 描画システム**: 位置更新の正確な反映
- [ ] **入力システム → 移動システム**: プレイヤー操作の即座反映  
- [ ] **AI システム → 物理システム**: 敵移動の自然な動作

#### リアルタイム更新テスト
- [ ] **エンティティ動的作成**: ゲーム実行中の弾丸・エフェクト生成
- [ ] **コンポーネント動的変更**: HPバー・ステータス変化のリアルタイム反映
- [ ] **システム順序変更**: 実行時のシステム優先度調整

### 長期安定性テスト

#### 持続運用テスト
- [ ] **24時間連続実行**: エラー発生率<0.01%、メモリ増加<50MB
- [ ] **10,000フレーム実行**: 平均フレーム時間の安定性確認
- [ ] **リソース解放**: 適切なエンティティ・コンポーネント削除確認

## API仕様概要

### コアインターフェース

```go
// EntityManager - エンティティ管理
type EntityManager interface {
    CreateEntity() EntityID
    DestroyEntity(EntityID)
    GetComponent(EntityID, ComponentType) Component
    AddComponent(EntityID, Component)
    RemoveComponent(EntityID, ComponentType)
    HasComponent(EntityID, ComponentType) bool
    GetEntitiesWith(ComponentType) []EntityID
}

// SystemManager - システム管理
type SystemManager interface {
    RegisterSystem(System)
    UnregisterSystem(SystemType)
    UpdateSystems(deltaTime float64) error
    RenderSystems(screen *ebiten.Image)
}

// System - ゲームシステム基底
type System interface {
    Update(deltaTime float64, entities EntityManager) error
    GetType() SystemType
}
```

### 基本コンポーネント

```go
// TransformComponent - 位置・回転・スケール
type TransformComponent struct {
    X, Y     float64
    Rotation float64
    ScaleX   float64
    ScaleY   float64
}

// SpriteComponent - スプライト描画
type SpriteComponent struct {
    Image  *ebiten.Image
    Width  int
    Height int
    Color  color.Color
}

// HealthComponent - HP管理
type HealthComponent struct {
    Current int
    Maximum int
}
```

## 実装ガイドライン

### ディレクトリ構造
```
internal/core/ecs/
├── entity.go          # EntityManager実装
├── component.go       # Component型定義・管理
├── system.go          # SystemManager実装
├── query.go           # エンティティクエリシステム
├── memory.go          # メモリ管理・最適化
└── tests/
    ├── entity_test.go
    ├── component_test.go
    ├── system_test.go
    ├── performance_test.go
    └── integration_test.go
```

### パフォーマンス最適化指針
1. **データ指向設計**: コンポーネントをメモリ効率的に配置
2. **バッチ処理**: 同種コンポーネントの一括処理
3. **キャッシュ効率**: CPUキャッシュを意識したメモリレイアウト
4. **並列処理**: 独立システムの並列実行

### エラーハンドリング方針
1. **防御的プログラミング**: 不正入力に対する適切な検証
2. **グレースフルエラー**: システム全体の停止を回避
3. **詳細ログ**: デバッグに必要な情報の記録
4. **型安全性**: コンパイル時エラーチェックの活用

---

**📋 要件定義書の活用方法**

この要件定義書は以下のフェーズで活用してください：

1. **設計フェーズ**: アーキテクチャ設計・インターフェース定義の基準
2. **実装フェーズ**: 開発優先度・機能仕様の参照
3. **テストフェーズ**: テストケース作成・品質基準設定  
4. **レビューフェーズ**: 受け入れ基準による実装評価

ECSフレームワークは Muscle Dreamer の中核技術であり、高品質な実装により後続開発の効率性・拡張性が大きく向上します。