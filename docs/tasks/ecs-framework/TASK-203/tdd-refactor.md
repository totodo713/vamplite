# TASK-203: EventBus実装 - TDD Refactor段階

## Refactor段階概要

Green段階で作成した動作する実装を、コード品質の向上とパフォーマンス最適化を行う段階です。
機能を変更せずに、保守性、性能、メモリ効率を改善します。

## Refactor対象

### 1. メモリ使用量最適化
**問題**: `TestEventBus_MemoryLeak`が失敗（18GB超のメモリ増加）
**解決策**:
- ワーカーゴルーチンのメモリ効率改善
- イベントキューのメモリプール活用
- 統計情報の効率的な更新

### 2. パフォーマンス最適化
**対象**:
- イベント配信の最適化
- ロック競合の削減
- 統計情報更新の最適化

### 3. コード品質改善
**対象**:
- エラーハンドリングの強化
- コードの可読性向上
- ドキュメント充実

## 実装計画

### Phase 1: メモリ最適化

#### 1.1 統計情報の効率化
```go
// 統計情報をatomic操作に変更
type EventBusStats struct {
    eventsPublished    *int64  // atomic.Int64
    eventsProcessed    *int64  // atomic.Int64
    eventsDropped      *int64  // atomic.Int64
    handlerErrors      *int64  // atomic.Int64
    handlerPanics      *int64  // atomic.Int64
    // 他のフィールドは保持
}
```

#### 1.2 メモリプールの導入
```go
type EventBusImpl struct {
    // 既存フィールド...
    eventPool sync.Pool // queuedEventのプール
}
```

#### 1.3 ワーカーゴルーチンの最適化
- メモリリークの原因を特定・修正
- ゴルーチンリークの防止

### Phase 2: パフォーマンス最適化

#### 2.1 ロック最適化
- Read/Writeロックの最適利用
- ロック保持時間の最小化

#### 2.2 イベント配信の最適化
- バッチ処理の導入（可能な場合）
- チャネル操作の最適化

### Phase 3: コード品質改善

#### 3.1 エラーハンドリング強化
- パニック回復機能
- より詳細なエラーメッセージ

#### 3.2 Flush機能の実装
- 未処理イベントの適切な処理

#### 3.3 ドキュメント改善
- コードコメントの充実
- パフォーマンス特性の文書化

## 実装順序

1. **統計情報のatomic化** - ロック競合削減
2. **メモリプールの導入** - メモリ効率改善
3. **ワーカーゴルーチンの最適化** - メモリリーク対策
4. **Flush機能の実装** - 未実装メソッドの完成
5. **エラーハンドリング強化** - 堅牢性向上
6. **パフォーマンステスト対応** - 要求スペック達成

## テスト結果目標

### Refactor完了時の期待結果
- ✅ 全基本機能テスト（9/10）継続成功
- ✅ `TestEventBus_MemoryLeak` - 50MB以下のメモリ増加
- ✅ `TestEventBus_HighThroughput` - 1000+ events/sec維持
- ✅ 全体テスト実行時間 < 1秒

### パフォーマンス目標
- メモリ使用量: <50MB increase for long-running tests
- スループット: >1000 events/second
- レイテンシ: <1ms average event processing
- ゴルーチン数: 安定（リーク無し）

## 制約事項

- **既存テストの動作を変更しない**
- **外部APIの変更は行わない**
- **既存の機能を削除・変更しない**
- **過剰な最適化は避ける**

## 成功基準

1. **全テストケースがパス**（メモリリークテスト含む）
2. **パフォーマンス要件を満たす**
3. **メモリ効率が改善される**
4. **コードの可読性が向上する**
5. **次のタスクへの準備が完了する**

## 次段階

Refactor完了後、`tdd-verify-complete.md`で最終検証を行い、TASK-203を完了させます。